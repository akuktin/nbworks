#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netinet/ip.h>

#define FALSE 0
#define TRUE  1

struct {
  unsigned long len;
  unsigned char pckt[100];
} dtg[] = {
{
  /* name_len too long */
  52, {
    0x10, 0x02, 0x01, 0x10,  0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,  0x3f, 0x20, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x00, 0x20, 0x00, 0x01
  }
},
{
  /* pointer to netherland */
  52, {
    0x10, 0x02, 0x01, 0x10,  0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,  0xff, 0xff, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x00, 0x20, 0x00, 0x01
  }
},
{
  /* pointer clipped in half */
  52, {
    0x10, 0x02, 0x01, 0x10,  0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,  0x22, 0x46, 0x20, 0x20,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x03,
    0x34, 0x20, 0x00, 0xff
  }
},
{
  /* RDATA_LEN too big */
  96, {
    0x10, 0x02, 0x40, 0x10,  0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01,  0x20, 0x46, 0x45, 0x45,
    0x46, 0x46, 0x44, 0x46,  0x45, 0x44, 0x43, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x41,  0x41, 0x00, 0x00, 0x20,
    0x00, 0x01, 0x20, 0x46,  0x45, 0x45, 0x46, 0x46,
    0x44, 0x46, 0x45, 0x44,  0x43, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x41, 0x41, 0x00,  0x00, 0x20, 0x00, 0x01,
    0x00, 0xf0, 0xff, 0x00,  0x05, 0x39, 0x00, 0x00
  }
},
{
  /* packet too short for all things, qst version*/
  12, {
    0x10, 0x02, 0x01, 0x10,  0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
  }
},
{
  /* packet too short for all things, res version*/
  12, {
    0x10, 0x02, 0x01, 0x10,  0x00, 0x00, 0x00, 0x01,
    0x00, 0x00, 0x00, 0x00
  }
},
{
  /* qst missing all parts */
  51, {
    0x10, 0x02, 0x01, 0x10,  0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,  0x22, 0x20, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x00, 0x20, 0x00
  }
},
{
  /* res missing all parts */
  93, {
    0x10, 0x02, 0x40, 0x10,  0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01,  0x20, 0x46, 0x45, 0x45,
    0x46, 0x46, 0x44, 0x46,  0x45, 0x44, 0x43, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x41,  0x41, 0x00, 0x00, 0x20,
    0x00, 0x01, 0x20, 0x46,  0x45, 0x45, 0x46, 0x46,
    0x44, 0x46, 0x45, 0x44,  0x43, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x41, 0x41, 0x00,  0x00, 0x20, 0x00, 0x01,
    0x00, 0xf0, 0xff, 0x00,  0x05
  }
},
{
  /* runt packet */
  7, {
    0x10, 0x02, 0x40, 0x10,  0x00, 0x01, 0x00
  }
}};

#include <nbworks.h>
typedef uint32_t ipv4_addr_t;
extern ipv4_addr_t nbworks__myip4addr;

int main() {
  struct sockaddr_in addr;
  int sckt, i, ret_val;

  addr.sin_family = AF_INET;
  fill_16field(137, (unsigned char *)$(addr.sin_port));
  fill_32field(nbworks__myip4addr, (unsigned char *)&(addr.sin_addr.s_addr));
  ret_val = 0;

  sckt = socket(PF_INET, SOCK_DGRAM, 0);
  if (sckt < 0) {
    fprintf(stderr, "could not open socket\n");
    ret_val = 1;
    return ret_val;
  }

  if (connect(sckt, &addr, sizeof(struct sockaddr_in))) {
    fprintf(stderr, "could not connect() socket\n");
    close(sckt);
    ret_val = 1;
    return ret_val;
  }

  for (i=0; i<10; i++) {
    fprintf(stderr, "sending name%i...", i +1);
    if (dtg[i].len > send(sckt, dtg[i].pckt, dtg[i].len, 0)) {
      fprintf(stderr, "failed\n");
      ret_val = 1;
      break;
    } else {
      fprintf(stderr, "succedded\n");
    }
  }

  close(sckt);
  if (ret_val)
    fprintf(stderr, "problems\n");
  else
    fprintf(stderr, "done\n");

  return ret_val;
}
