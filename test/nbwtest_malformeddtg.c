#include <stdio.h>
#include <nbworks.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netinet/ip.h>

#define FALSE 0
#define TRUE  1

struct {
  unsigned long len;
  unsigned char pckt[100];
} dtg[] = {
{
  /* dtg_len too big */
  84, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x50,  0x00, 0x00, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x20, 0x46, 0x45, 0x45,  0x42, 0x46, 0x43, 0x45,
    0x48, 0x45, 0x46, 0x46,  0x45, 0x45, 0x48, 0x46,
    0x43, 0x46, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x00, 0x6c, 0x6c
  }
},
{
  /* first name too long */
  94, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x50,  0x00, 0x00, 0x3f, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x20, 0x46, 0x45, 0x45,  0x42, 0x46, 0x43, 0x45,
    0x48, 0x45, 0x46, 0x46,  0x45, 0x45, 0x48, 0x46,
    0x43, 0x46, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x00, 0x48, 0x65,  0x6c, 0x6c, 0x6f, 0x20,
    0x57, 0x6f, 0x72, 0x6c,  0x64, 0x21
  }
},
{
  /* second name too long */
  94, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x50,  0x00, 0x00, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x3f, 0x46, 0x45, 0x45,  0x42, 0x46, 0x43, 0x45,
    0x48, 0x45, 0x46, 0x46,  0x45, 0x45, 0x48, 0x46,
    0x43, 0x46, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x00, 0x48, 0x65,  0x6c, 0x6c, 0x6f, 0x20,
    0x57, 0x6f, 0x72, 0x6c,  0x64, 0x21
  }
},
{
  /* second name has pointer to netherland */
  94, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x50,  0x00, 0x00, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x2b, 0x46, 0x45, 0x45,  0x42, 0x46, 0x43, 0x45,
    0x48, 0x45, 0x46, 0x46,  0x45, 0x45, 0x48, 0x46,
    0x43, 0x46, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x00, 0x48, 0x65,  0x6c, 0x6c, 0x6f, 0x20,
    0x57, 0x6f, 0x72, 0x6c,  0xff, 0xff
  }
},
{
  /* second name has pointer that extends beyond the packet */
  94, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x50,  0x00, 0x00, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
    0x2c, 0x46, 0x45, 0x45,  0x42, 0x46, 0x43, 0x45,
    0x48, 0x45, 0x46, 0x46,  0x45, 0x45, 0x48, 0x46,
    0x43, 0x46, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x00, 0x48, 0x65,  0x6c, 0x6c, 0x6f, 0x20,
    0x57, 0x6f, 0x72, 0x6c,  0xff, 0xff
  }
},
{
  /* dtg_len filled with bullshit (equals 1) */
  49, { /* dst: TEST2<00> */
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x01,  0x00, 0x00, 0x00, 0x20,
    0x46, 0x45, 0x45, 0x42,  0x46, 0x43, 0x45, 0x48,
    0x45, 0x46, 0x46, 0x45,  0x45, 0x48, 0x46, 0x43,
    0x46, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,

    0x43, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,
    0x00
  }
},
{
  /* runt datagram */
  3, {
    0x10, 0x02, 0x80
  }
},
{
  /* datagram missing constituent parts */
  18, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x50,  0x00
  }
},
{
  /* missing second name */
  48, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x22,  0x00, 0x00, 0x20, 0x46,
    0x45, 0x45, 0x46, 0x46,  0x44, 0x46, 0x45, 0x44,
    0x42, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,
    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x43,

    0x41, 0x43, 0x41, 0x43,  0x41, 0x43, 0x41, 0x00,
  }
},
{
  /* first name jutting out of the data section */
  57, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x05,  0x00, 0x00, 0x07, 0x41,
    0x41, 0x41, 0x41, 0x41,  0x41, 0x41, 0x00, 0x20,
    0x46, 0x45, 0x45, 0x42,  0x46, 0x43, 0x45, 0x48,
    0x45, 0x46, 0x46, 0x45,  0x45, 0x48, 0x46, 0x43,

    0x46, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,
    0x43, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,
    0x00
  }
},
{
  /* first name taking up whole of the data section */
  57, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x09,  0x00, 0x00, 0x07, 0x41,
    0x41, 0x41, 0x41, 0x41,  0x41, 0x41, 0x00, 0x20,
    0x46, 0x45, 0x45, 0x42,  0x46, 0x43, 0x45, 0x48,
    0x45, 0x46, 0x46, 0x45,  0x45, 0x48, 0x46, 0x43,

    0x46, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,
    0x43, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,
    0x00
  }
},
{
  /* second name jutting out of the data section */
  57, {
    0x10, 0x02, 0x80, 0xd4,  0xc0, 0xa8, 0x01, 0x05,
    0x00, 0x8a, 0x00, 0x22,  0x00, 0x00, 0x07, 0x41,
    0x41, 0x41, 0x41, 0x41,  0x41, 0x41, 0x00, 0x20,
    0x46, 0x45, 0x45, 0x42,  0x46, 0x43, 0x45, 0x48,
    0x45, 0x46, 0x46, 0x45,  0x45, 0x48, 0x46, 0x43,

    0x46, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,
    0x43, 0x41, 0x43, 0x41,  0x43, 0x41, 0x43, 0x41,
    0x00
  }
}
  /* second name taking up whole data section is not an error:
   * that's how datagrams with no data look. */
};

#include <nbworks.h>
typedef uint32_t ipv4_addr_t;
extern ipv4_addr_t nbworks__myip4addr;

int main() {
  struct sockaddr_in addr;
  int sckt, ret_val, i;

  nbworks_libinit();

  addr.sin_family = AF_INET;
  fill_16field(138, (unsigned char *)&(addr.sin_port));
  fill_32field(nbworks__myip4addr, (unsigned char *)&(addr.sin_addr.s_addr));
  ret_val = 0;

  sckt = socket(PF_INET, SOCK_DGRAM, 0);
  if (sckt < 0) {
    fprintf(stderr, "could not open socket\n");
    ret_val = 1;
    return ret_val;
  }

  if (connect(sckt, &addr, sizeof(struct sockaddr_in))) {
    fprintf(stderr, "could not connect() socket\n");
    ret_val = 1;
    return ret_val;
  }

  for (i=0; i<12; i++) {
    fprintf(stderr, "sending dtg%i...", i +1);
    if (dtg[i].len > send(sckt, dtg[i].pckt, dtg[i].len, 0)) {
      fprintf(stderr, "failed\n");
      ret_val = 1;
      break;
    } else {
      fprintf(stderr, "succedded\n");
    }

    sleep(2);
  }

  close(sckt);
  if (ret_val)
    fprintf(stderr, "problems\n");
  else
    fprintf(stderr, "done\n");

  return 0;
}
